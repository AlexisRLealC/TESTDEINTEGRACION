// ===================================================================
// VARIABLES GLOBALES
// ===================================================================
let sdkReady = false;  // Flag para verificar si el SDK est√° listo

// ===================================================================
// SDK INITIALIZATION - Inicializaci√≥n del Facebook JavaScript SDK
// ===================================================================
// Esta funci√≥n se ejecuta autom√°ticamente cuando el SDK termina de cargar
// Documentaci√≥n: https://developers.facebook.com/docs/javascript/reference/FB.init
window.fbAsyncInit = function() {
    // Configuraci√≥n del SDK seg√∫n documentaci√≥n oficial
    FB.init({
        appId: window.APP_CONFIG.APP_ID,         // ID de tu app de Meta/Facebook
        autoLogAppEvents: true,                   // Logging autom√°tico de eventos
        xfbml: true,                             // Habilitar parsing de XFBML
        version: 'v23.0'                        // Versi√≥n m√°s reciente de Graph API
    });
    
    console.log('‚úÖ Facebook SDK inicializado correctamente');
    sdkReady = true;
    
    // Actualizar UI
    const statusDiv = document.getElementById('sdk-status');
    statusDiv.className = 'sdk-status sdk-ready';
    statusDiv.innerHTML = '‚úÖ Facebook SDK listo para usar';
    
    const signupBtn = document.getElementById('whatsapp-signup-btn');
    signupBtn.disabled = false;
    signupBtn.innerHTML = 'üì± Iniciar WhatsApp Embedded Signup';
};

// ===================================================================
// SESSION LOGGING MESSAGE EVENT LISTENER
// ===================================================================
// Este listener captura mensajes enviados desde Facebook durante el flujo
// de Embedded Signup. Los mensajes contienen informaci√≥n cr√≠tica como:
// - WABA ID (WhatsApp Business Account ID)
// - Phone Number ID
// - Estado del flujo (CURRENT_STEP)
// - Informaci√≥n de abandono si el usuario cancela
// Documentaci√≥n: https://developers.facebook.com/docs/whatsapp/embedded-signup/implementation
window.addEventListener('message', (event) => {
    if (!event.origin.endsWith('facebook.com')) return;
    
    try {
        const data = JSON.parse(event.data);
        if (data.type === 'WA_EMBEDDED_SIGNUP') {
            console.log('üì± Evento WhatsApp Embedded Signup:', data);
            
            const resultsDiv = document.getElementById('signup-results');
            resultsDiv.style.display = 'block';
            resultsDiv.innerHTML = `
                <div class="success">
                    <h3>üì± Datos de Sesi√≥n WhatsApp</h3>
                    <p>Se recibieron datos importantes del flujo de signup:</p>
                    <div class="json-display">${JSON.stringify(data, null, 2)}</div>
                    <p><small>üí° Estos datos incluyen WABA ID, Phone Number ID, y estado del flujo</small></p>
                </div>
            `;
            
            // Enviar al servidor para procesamiento
            fetch('/api/process-signup-data', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            }).catch(console.error);
        }
    } catch (error) {
        console.log('üì® Mensaje raw de Facebook:', event.data);
        
        const resultsDiv = document.getElementById('signup-results');
        resultsDiv.style.display = 'block';
        resultsDiv.innerHTML = `
            <div class="info-box">
                <h3>üì® Mensaje de Facebook</h3>
                <div class="json-display">${event.data}</div>
            </div>
        `;
    }
});

// ===================================================================
// RESPONSE CALLBACK - Manejo de respuesta de autenticaci√≥n
// ===================================================================
// Esta funci√≥n se ejecuta cuando el usuario completa o cancela el flujo
// de Embedded Signup. La respuesta contiene:
// - authResponse.code: C√≥digo intercambiable (TTL: 30 segundos)
// - Este c√≥digo debe intercambiarse r√°pidamente por un token de acceso
// - Si no hay authResponse, significa error o cancelaci√≥n del usuario
// Documentaci√≥n: https://developers.facebook.com/docs/whatsapp/embedded-signup/implementation
const fbLoginCallback = (response) => {
    console.log('üîÑ Respuesta completa del callback:', response);
    
    const resultsDiv = document.getElementById('results');
    resultsDiv.style.display = 'block';
    
    if (response.authResponse && response.authResponse.code) {
        const code = response.authResponse.code;
        console.log('üéØ C√≥digo intercambiable recibido:', code);
        
        resultsDiv.innerHTML = `
            <div class="success">
                <h3>üéâ ¬°Embedded Signup Completado Exitosamente!</h3>
                <p><strong>‚úÖ C√≥digo intercambiable:</strong> <code style="background: #f8f9fa; padding: 5px; border-radius: 3px;">${code}</code></p>
                <p><strong>‚è∞ TTL:</strong> 30 segundos (intercambiar r√°pidamente)</p>
                <p><strong>üîÑ Estado:</strong> Enviando al servidor para intercambio por token...</p>
            </div>
        `;
        
        // Intercambiar c√≥digo por token en el servidor
        fetch('/api/exchange-token', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ code: code })
        })
        .then(response => response.json())
        .then(data => {
            resultsDiv.innerHTML += `
                <div class="info-box">
                    <h3>üîÑ Resultado del Intercambio de Token</h3>
                    <div class="json-display">${JSON.stringify(data, null, 2)}</div>
                </div>
            `;
        })
        .catch(error => {
            console.error('Error en intercambio:', error);
            resultsDiv.innerHTML += `
                <div class="error">
                    <h3>‚ùå Error en el Intercambio</h3>
                    <p>No se pudo intercambiar el c√≥digo por el token: ${error.message}</p>
                    <p><small>Verifica que el servidor est√© funcionando y que las credenciales sean correctas.</small></p>
                </div>
            `;
        });
    } else {
        console.log('‚ùå Error o cancelaci√≥n del usuario:', response);
        resultsDiv.innerHTML = `
            <div class="warning">
                <h3>‚ö†Ô∏è Flujo Cancelado o Error</h3>
                <p>El usuario cancel√≥ el flujo o ocurri√≥ un error:</p>
                <div class="json-display">${JSON.stringify(response, null, 2)}</div>
            </div>
        `;
    }
};

// ===================================================================
// LAUNCH METHOD - Iniciar el flujo de WhatsApp Embedded Signup
// ===================================================================
// Esta funci√≥n lanza el flujo oficial de Embedded Signup usando FB.login()
// Par√°metros importantes:
// - config_id: ID de configuraci√≥n creado en Meta Developer Console
// - response_type: 'code' para recibir c√≥digo intercambiable
// - override_default_response_type: true (requerido para WhatsApp)
// - extras.featureType: '' (vac√≠o para flujo por defecto)
// - extras.sessionInfoVersion: '3' (versi√≥n actual)
// Documentaci√≥n: https://developers.facebook.com/docs/whatsapp/embedded-signup/implementation
const launchWhatsAppSignup = () => {
    if (!sdkReady) {
        alert('‚è≥ El SDK de Facebook a√∫n se est√° cargando. Espera un momento.');
        return;
    }
    
    console.log('üöÄ Iniciando WhatsApp Embedded Signup...');
    
    // Limpiar resultados anteriores
    document.getElementById('results').style.display = 'none';
    document.getElementById('signup-results').style.display = 'none';
    
    FB.login(fbLoginCallback, {
        config_id: window.APP_CONFIG.CONFIGURATION_ID,  // ID de configuraci√≥n de WhatsApp
        response_type: 'code',
        override_default_response_type: true,
        extras: {
            setup: {},
            featureType: '', // Vac√≠o para flujo por defecto
            sessionInfoVersion: '3'
        }
    });
};

// ===================================================================
// INSTAGRAM LOGIN - Instagram Business Login (Directo)
// ===================================================================
// Implementaci√≥n actualizada para usar Instagram Business Login directo
// https://developers.facebook.com/docs/instagram-platform/instagram-api-with-instagram-login/business-login
function launchInstagramLogin() {
    console.log('üì∏ Iniciando Instagram Business Login (Directo)...');
    
    if (!window.APP_CONFIG.INSTAGRAM_APP_ID) {
        alert('‚ùå Error: INSTAGRAM_APP_ID no configurado en el servidor');
        return;
    }
    
    // Generar estado √∫nico para seguridad
    const state = 'ig_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    
    console.log('üîó Configuraci√≥n de Instagram Business Login:', {
        app_id: window.APP_CONFIG.INSTAGRAM_APP_ID,
        redirect_uri: window.APP_CONFIG.INSTAGRAM_REDIRECT_URI,
        state: state,
        method: 'Instagram Business Login (Direct)'
    });
    
    // Mostrar informaci√≥n del proceso
    const resultsDiv = document.getElementById('results');
    resultsDiv.style.display = 'block';
    resultsDiv.innerHTML = `
        <div class="info-box">
            <h3>üì∏ Instagram Business Login (Directo)</h3>
            <p>Iniciando proceso de autorizaci√≥n oficial de Instagram...</p>
            <p><strong>Flujo:</strong> Instagram API with Instagram Login</p>
            <p><strong>M√©todo:</strong> Business Login for Instagram</p>
            <p><strong>Endpoint:</strong> instagram.com/oauth/authorize</p>
            
            <h4>üîê Permisos Solicitados (Nuevos Scopes 2025):</h4>
            <ul style="text-align: left;">
                <li><strong>instagram_business_basic:</strong> Acceso b√°sico al perfil comercial</li>
                <li><strong>instagram_business_content_publish:</strong> Publicar contenido</li>
                <li><strong>instagram_business_manage_messages:</strong> Gestionar mensajes</li>
                <li><strong>instagram_business_manage_comments:</strong> Gestionar comentarios</li>
            </ul>
            
            <div style="background: #d1ecf1; padding: 10px; border-radius: 5px; margin: 10px 0; color: #0c5460;">
                <p><strong>‚ú® Nuevo:</strong> Instagram Login Directo en Popup</p>
                <p><strong>üìã Estado de la Sesi√≥n:</strong> ${state}</p>
                <p><strong>ü™ü Abriendo ventana...</strong> Se abrir√° una ventana peque√±a para la autorizaci√≥n</p>
                <p><strong>üîÑ Forzar login:</strong> Siempre pedir√° credenciales de Instagram</p>
            </div>
            
            <div style="background: #fff3cd; padding: 10px; border-radius: 5px; margin: 10px 0; color: #856404;">
                <p><strong>‚ö†Ô∏è Nota:</strong> Si no se abre la ventana popup, verifica que no est√© bloqueada por tu navegador.</p>
                <p><strong>üîí Seguridad:</strong> La ventana se cerrar√° autom√°ticamente al completar la autorizaci√≥n.</p>
            </div>
        </div>
    `;
    
    // URL del endpoint de Instagram con force_reauth para siempre pedir login
    const authUrl = `/instagram/login?force_reauth=true&state=${state}`;
    
    // Configuraci√≥n de la ventana popup
    const popupFeatures = [
        'width=500',           // Ancho de la ventana
        'height=700',          // Alto de la ventana
        'left=' + (screen.width / 2 - 250),   // Centrar horizontalmente
        'top=' + (screen.height / 2 - 350),   // Centrar verticalmente
        'scrollbars=yes',      // Permitir scroll si es necesario
        'resizable=yes',       // Permitir redimensionar
        'status=no',           // Sin barra de estado
        'toolbar=no',          // Sin barra de herramientas
        'menubar=no',          // Sin barra de men√∫
        'location=no'          // Sin barra de direcci√≥n
    ].join(',');
    
    console.log('ü™ü Abriendo popup de Instagram Login:', {
        url: authUrl,
        features: popupFeatures
    });
    
    // Abrir ventana popup
    const popup = window.open(authUrl, 'instagram_login', popupFeatures);
    
    // Verificar si la ventana se abri√≥ correctamente
    if (!popup) {
        alert('‚ùå Error: No se pudo abrir la ventana popup. Verifica que no est√© bloqueada por tu navegador.');
        return;
    }
    
    // Enfocar la ventana popup
    popup.focus();
    
    // Monitorear el estado de la ventana popup
    const checkClosed = setInterval(() => {
        if (popup.closed) {
            clearInterval(checkClosed);
            console.log('ü™ü Ventana popup cerrada');
            
            // Actualizar la UI para mostrar que se cerr√≥ la ventana
            const statusDiv = resultsDiv.querySelector('.info-box');
            if (statusDiv) {
                statusDiv.innerHTML += `
                    <div style="background: #f8d7da; padding: 10px; border-radius: 5px; margin: 10px 0; color: #721c24;">
                        <p><strong>ü™ü Ventana cerrada</strong></p>
                        <p>Si completaste la autorizaci√≥n, la p√°gina se actualizar√° autom√°ticamente.</p>
                        <p>Si cancelaste, puedes intentar de nuevo haciendo clic en el bot√≥n.</p>
                    </div>
                `;
            }
        }
    }, 1000);
    
    // Timeout de seguridad para limpiar el interval despu√©s de 10 minutos
    setTimeout(() => {
        clearInterval(checkClosed);
    }, 600000); // 10 minutos
}

// Funci√≥n de verificaci√≥n de estado
function checkStatus() {
    fetch('/api/status')
        .then(response => response.json())
        .then(data => {
            const results = document.getElementById('results');
            results.style.display = 'block';
            results.innerHTML = `
                <div class="info-box">
                    <h3>üìä Estado del Servidor</h3>
                    <div class="json-display">${JSON.stringify(data, null, 2)}</div>
                </div>
            `;
        })
        .catch(error => {
            console.error('Error:', error);
            const results = document.getElementById('results');
            results.style.display = 'block';
            results.innerHTML = `
                <div class="error">
                    <h3>‚ùå Error de Conexi√≥n</h3>
                    <p>No se pudo obtener el estado del servidor: ${error.message}</p>
                </div>
            `;
        });
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    const signupBtn = document.getElementById('whatsapp-signup-btn');
    if (signupBtn) {
        signupBtn.addEventListener('click', launchWhatsAppSignup);
    }
});
